<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreEnglish - Audrey</title>
    <style>
        :root { --golf-green: #2d5a27; --grass-light: #ebf5e9; --accent: #e63946; --gold: #fbc02d; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f0; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        #game-card { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); text-align: center; border: 4px solid var(--golf-green); }
        .header-emoji { font-size: 60px; margin-bottom: 10px; }
        .npc-msg { background: var(--grass-light); padding: 25px; border-radius: 25px; font-size: 22px; color: #1b5e20; margin-bottom: 20px; min-height: 80px; line-height: 1.5; position: relative; font-weight: 600; }
        .npc-msg::after { content: ''; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); border-width: 15px 15px 0; border-style: solid; border-color: var(--grass-light) transparent; }
        #visual-hint { display: none; background: #fff; border: 2px solid var(--gold); border-radius: 10px; padding: 15px; margin: 10px auto; width: 80%; }
        #visual-img { width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; margin-top: 10px; }
        .controls { margin-top: 30px; position: relative; }
        #timer-display { font-size: 24px; font-weight: bold; color: var(--accent); margin-bottom: 10px; visibility: hidden; }
        .mic-btn { width: 120px; height: 120px; border-radius: 50%; border: 8px solid white; cursor: pointer; background: var(--golf-green); color: white; font-size: 18px; font-weight: bold; transition: all 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .mic-btn.recording { background: var(--accent); animation: pulse 1.5s infinite; }
        
        /* Skip ÊåâÈíÆÊ†∑Âºè */
        .skip-btn { 
            display: none; 
            margin-top: 15px; 
            padding: 12px 25px; 
            background: var(--gold); 
            border: none; 
            color: #5d4037; 
            border-radius: 50px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);} }

        .retry-btn { display: none; padding: 15px 35px; background: var(--gold); border: none; color: #5d4037; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(230, 57, 70, 0.7); } 100% { box-shadow: 0 0 0 25px rgba(230, 57, 70, 0); } }
        #status { margin-top: 20px; font-weight: bold; color: #777; letter-spacing: 1px; }
        .hint-overlay { background: #fffde7; padding: 15px; border-radius: 20px; border: 2px dashed var(--gold); margin-top: 25px; display: none; color: #856404; }
        .progress-container { width: 100%; background: #eee; height: 12px; border-radius: 10px; margin-bottom: 25px; overflow: hidden; }
        #progress-inner { height: 100%; background: linear-gradient(90deg, #4caf50, #2d5a27); width: 0%; transition: 0.5s; }
    </style>
</head>
<body>
    <div id="game-card">
        <div class="header-emoji" id="big-emoji">‚õ≥</div>
        <div class="progress-container"><div id="progress-inner"></div></div>
        <div id="visual-hint">
            <div id="visual-text" style="color: #d32f2f; font-weight: bold; margin-bottom: 5px;"></div>
            <img id="visual-img" src="" style="display:none;">
        </div>
        <div id="npc-text" class="npc-msg">Hi there! Ready to practice?</div>
        <div id="timer-display">10</div>
        <div id="status">PLEASE WAIT</div>
        <div class="controls"><center>
            <button id="mic-btn" class="mic-btn" onclick="handleMicClick()">
                <span id="mic-icon" style="font-size:30px">üé§</span>
                <span id="mic-text">START</span>
            </button>
            <button id="skip-btn" class="skip-btn" onclick="skipQuestion()">‚è© Too hard? Skip it!</button>
            <button id="retry-btn" class="retry-btn" onclick="resetGame()">üîÑ Play Again</button>
        </center></div>
        <div id="hint-box" class="hint-overlay"><strong>üí° Hint:</strong><br><span id="hint-text"></span></div>
    </div>

    <script>
        let scenario = []; let step = -1; let isRecording = false; 
        let countdownValue = 10; let countdownInterval;
        let failCount = 0; // ÈîôËØØËÆ°Êï∞Âô®

        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.lang = 'en-US';

        async function loadData() {
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date') || '20260205'; 
            try {
                const response = await fetch(`./data/${dateParam}.json`);
                if (!response.ok) throw new Error();
                scenario = await response.json();
                document.getElementById('npc-text').innerText = "Hi there! Ready to practice?";
                document.getElementById('status').innerText = "PRESS START";
            } catch (err) {
                document.getElementById('npc-text').innerText = "Lesson Not Found: " + dateParam;
                document.getElementById('status').innerText = "ERROR";
            }
        }
        loadData();

        function speak(text, callback) {
            window.speechSynthesis.cancel();
            const m = new SpeechSynthesisUtterance(text);
            m.lang = 'en-US'; m.rate = 0.9;
            if (callback) m.onend = callback;
            window.speechSynthesis.speak(m);
        }

        function handleMicClick() {
            if (scenario.length === 0) return;
            if (step === -1) { step = 0; startStep(); return; }
            if (!isRecording) startRecording(); else stopRecording();
        }

        function startStep() {
            clearInterval(countdownInterval);
            failCount = 0; // ÈáçÁΩÆÊú¨È¢òÈîôËØØËÆ°Êï∞
            document.getElementById('timer-display').style.visibility = 'hidden';
            document.getElementById('hint-box').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'none';
            
            if (step >= scenario.length) {
                updateUI("Lesson Complete!", "You're a Pro!", "üèÜ");
                speak("Fantastic job!");
                document.getElementById('mic-btn').style.display = 'none';
                document.getElementById('retry-btn').style.display = 'inline-block';
                return;
            }

            const current = scenario[step];
            updateUI(current.q, "Listening...", current.emoji);
            
            const vHint = document.getElementById('visual-hint');
            const vText = document.getElementById('visual-text');
            const vImg = document.getElementById('visual-img');
            if (current.visual || current.image) {
                vHint.style.display = 'block';
                vText.innerText = current.visual || "";
                if (current.image) { vImg.src = current.image; vImg.style.display = 'block'; }
                else { vImg.style.display = 'none'; }
            } else { vHint.style.display = 'none'; }
            
            document.getElementById('progress-inner').style.width = ((step/scenario.length)*100) + "%";
            speak(current.q, () => {
                document.getElementById('status').innerText = "TAP TO SPEAK";
                document.getElementById('mic-text').innerText = "TALK";
            });
        }

        function startTimer() {
            clearInterval(countdownInterval);
            countdownValue = 10;
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.style.visibility = 'visible';
            timerDisplay.innerText = countdownValue;
            countdownInterval = setInterval(() => {
                countdownValue--;
                timerDisplay.innerText = countdownValue;
                if (countdownValue <= 0) {
                    clearInterval(countdownInterval);
                    stopRecording();
                    handleFailure("Time's up!");
                }
            }, 1000);
        }

        rec.onresult = (e) => {
            const speech = e.results[0][0].transcript.toLowerCase();
            const current = scenario[step];
            stopRecording();
            
            if (speech.includes("don't know") || speech.includes("dont know")) {
                handleFailure("No worries!");
                return;
            }

            const matchShort = current.keys.some(k => speech.includes(k.toLowerCase()));
            const matchLong = speech.includes(current.full.toLowerCase().replace(/[.,!?]/g, ""));

            if (matchShort || matchLong) {
                document.getElementById('big-emoji').innerText = "‚úÖ";
                speak("Great!", () => { step++; setTimeout(startStep, 800); });
            } else { 
                handleFailure(); 
            }
        };

        function handleFailure(customMsg) {
            clearInterval(countdownInterval);
            failCount++; // Â¢ûÂä†ÈîôËØØËÆ°Êï∞
            const current = scenario[step];
            
            // Â¶ÇÊûúÈîôËØØËææÂà∞4Ê¨°ÔºåÊòæÁ§∫ Skip ÊåâÈíÆ
            if (failCount >= 4) {
                document.getElementById('skip-btn').style.display = 'inline-block';
            }

            const feedbackText = `Try saying: "${current.full}"`;
            document.getElementById('npc-text').innerText = feedbackText;
            document.getElementById('npc-text').style.color = "#d32f2f";
            document.getElementById('timer-display').style.visibility = 'hidden';
            document.getElementById('big-emoji').innerText = "üì¢";
            document.getElementById('status').innerText = customMsg || "Keep trying!";
            
            speak((customMsg || "") + " Try saying: " + current.full, () => {
                document.getElementById('npc-text').style.color = "#1b5e20";
                startRecording();
            });
        }

        function skipQuestion() {
            speak("No problem, let's move to the next one.", () => {
                step++;
                startStep();
            });
        }

        function startRecording() { 
            try { 
                rec.start(); 
                isRecording = true; 
                document.getElementById('mic-btn').classList.add('recording'); 
                startTimer();
            } catch(e){} 
        }

        function stopRecording() { 
            rec.stop(); 
            isRecording = false; 
            clearInterval(countdownInterval);
            document.getElementById('mic-btn').classList.remove('recording'); 
        }
        
        function updateUI(n, s, e) { 
            document.getElementById('npc-text').innerText = n; 
            document.getElementById('npc-text').style.color = "#1b5e20";
            document.getElementById('status').innerText = s; 
            if(e) document.getElementById('big-emoji').innerText = e; 
        }
        
        function resetGame() { location.reload(); }
        rec.onerror = () => { stopRecording(); };
    </script>
</body>
</html>
