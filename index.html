<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreEnglish - Audrey</title>
    <style>
        :root { --golf-green: #2d5a27; --grass-light: #ebf5e9; --accent: #e63946; --gold: #fbc02d; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f0; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        #game-card { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); text-align: center; border: 4px solid var(--golf-green); }
        .header-emoji { font-size: 60px; margin-bottom: 10px; }
        .npc-msg { background: var(--grass-light); padding: 25px; border-radius: 25px; font-size: 22px; color: #1b5e20; margin-bottom: 20px; min-height: 80px; line-height: 1.5; position: relative; font-weight: 600; }
        .npc-msg::after { content: ''; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); border-width: 15px 15px 0; border-style: solid; border-color: var(--grass-light) transparent; }
        #visual-hint { display: none; background: #fff; border: 2px solid var(--gold); border-radius: 10px; padding: 15px; margin: 10px auto; width: 80%; }
        #visual-text { color: #d32f2f; font-weight: bold; margin-bottom: 5px; font-size: 18px; }
        #timer-container { width: 60%; height: 8px; background: #eee; margin: 15px auto; border-radius: 10px; overflow: hidden; display: none; border: 1px solid #ddd; }
        #timer-bar { height: 100%; background: var(--accent); width: 100%; }
        .controls { margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 20px; }
        .nav-btn { background: #fff; border: 2px solid var(--golf-green); color: var(--golf-green); padding: 12px 18px; border-radius: 15px; cursor: pointer; font-weight: bold; visibility: hidden; }
        .mic-btn { width: 110px; height: 110px; border-radius: 50%; border: 6px solid white; cursor: pointer; background: var(--golf-green); color: white; font-size: 16px; font-weight: bold; transition: all 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .mic-btn.recording { background: var(--accent); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(230, 57, 70, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(230, 57, 70, 0); } }
        #status { margin-top: 10px; font-weight: bold; color: #777; letter-spacing: 1px; font-size: 14px; text-transform: uppercase; }
        .progress-container { width: 100%; background: #eee; height: 12px; border-radius: 10px; margin-bottom: 25px; overflow: hidden; }
        #progress-inner { height: 100%; background: linear-gradient(90deg, #4caf50, #2d5a27); width: 0%; transition: 0.5s; }
        .retry-btn { display: none; padding: 15px 35px; background: var(--gold); border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="game-card">
        <div class="header-emoji" id="big-emoji">â›³</div>
        <div class="progress-container"><div id="progress-inner"></div></div>
        <div id="visual-hint"><div id="visual-text"></div></div>
        <div id="npc-text" class="npc-msg">Ready?</div>
        <div id="status">PRESS START</div>
        <div id="timer-container"><div id="timer-bar"></div></div>
        <div class="controls">
            <button id="back-btn" class="nav-btn" onclick="goBack()">â—€ Back</button>
            <button id="mic-btn" class="mic-btn" onclick="handleMicClick()">
                <span id="mic-icon" style="font-size:28px">ðŸŽ¤</span>
                <span id="mic-text">START</span>
            </button>
            <button id="skip-btn" class="nav-btn" onclick="goNext()">Skip â–¶</button>
        </div>
        <center><button id="retry-btn" class="retry-btn" onclick="resetGame()">ðŸ”„ Play Again</button></center>
    </div>

    <script>
        let scenario = []; let step = -1; let isRecording = false;
        let countdownTimer; const COUNTDOWN_TIME = 10000;
        const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        rec.lang = 'en-US'; rec.continuous = false;

        async function loadData() {
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date') || '20260219'; 
            try {
                const response = await fetch(`./data/${dateParam}.json`);
                scenario = await response.json();
                document.getElementById('status').innerText = "PRESS START";
            } catch (err) { document.getElementById('npc-text').innerText = "Lesson Not Found."; }
        }
        loadData();

        // å¼ºåŠ›æ¸…æ´—ï¼šå‰”é™¤æ‰€æœ‰æ’‡å·å’Œæ ‡ç‚¹
        function clean(t) { 
            return t.toLowerCase()
                    .replace(/['â€™â€˜`]/g, "") // å½»åº•åˆ é™¤å„ç§æ’‡å·
                    .replace(/[.,\/#!$%\^&\*;:{}=\-_~()]/g, "") 
                    .replace(/\s\s+/g, ' ')
                    .trim(); 
        }

        function speak(text, callback) {
            window.speechSynthesis.cancel();
            const eng = text.replace(/[\u4e00-\u9fa5]|ï¼ˆ[^ï¼‰]*ï¼‰|\([^)]*\)/g, "").trim();
            const m = new SpeechSynthesisUtterance(eng);
            m.lang = 'en-US'; m.rate = 0.9;
            if (callback) m.onend = callback;
            window.speechSynthesis.speak(m);
        }

        rec.onresult = (e) => {
            clearTimeout(countdownTimer);
            const rawSpeech = e.results[0][0].transcript;
            const speech = clean(rawSpeech);
            const speechWords = speech.split(' ');
            const current = scenario[step];
            
            const isCorrect = current.keys.some(k => {
                const cleanK = clean(k);
                const kWords = cleanK.split(' ');
                
                // 1. åŒ…å«æ ¸å¿ƒè¯ç»„
                if (speech.includes(cleanK)) return true;
                
                // 2. æ ¸å¿ƒè¯æ¯”çŽ‡åŒ¹é…
                let matchCount = 0;
                kWords.forEach(word => { if (speechWords.includes(word)) matchCount++; });
                if (matchCount / kWords.length >= 0.6) return true;

                return false;
            });

            if (isCorrect) {
                document.getElementById('big-emoji').innerText = "âœ…";
                speak("Great!", () => { step++; setTimeout(startStep, 800); });
            } else { handleFailure(); }
        };

        function handleFailure() {
            stopRecording();
            const current = scenario[step];
            document.getElementById('npc-text').innerText = `Try: "${current.full}"`;
            document.getElementById('npc-text').style.color = "#d32f2f";
            document.getElementById('big-emoji').innerText = "ðŸ“¢";
            speak("Try saying: " + current.full, () => {
                document.getElementById('npc-text').style.color = "#1b5e20";
                startRecording();
            });
        }

        function handleMicClick() { 
            if (step === -1) { step = 0; startStep(); return; } 
            if (isRecording) stopRecording(); else startRecording(); 
        }

        function startStep() {
            clearTimeout(countdownTimer); resetTimerUI();
            const micBtn = document.getElementById('mic-btn');
            
            if (step >= scenario.length) { 
                updateUI("Complete!", "Pro!", "ðŸ†"); 
                speak("Fantastic!"); 
                micBtn.style.display='none'; 
                document.getElementById('retry-btn').style.display='inline-block'; 
                document.getElementById('back-btn').style.visibility='visible'; 
                document.getElementById('skip-btn').style.visibility='hidden';
                return; 
            }

            // æ ¸å¿ƒä¿®å¤ï¼šè¿”å›žå‰é¢é¢˜æ—¶é‡æ–°æ˜¾ç¤º TALK æŒ‰é’®
            micBtn.style.display='flex';
            document.getElementById('retry-btn').style.display='none';
            document.getElementById('back-btn').style.visibility = step > 0 ? 'visible' : 'hidden';
            document.getElementById('skip-btn').style.visibility = 'visible';

            const cur = scenario[step];
            const qEng = cur.q.replace(/[\u4e00-\u9fa5]|ï¼ˆ[^ï¼‰]*ï¼‰|\([^)]*\)/g, "").trim();
            updateUI(qEng, "Listening...", cur.emoji);
            
            const cMatch = cur.q.match(/[\u4e00-\u9fa5]|ï¼ˆ[^ï¼‰]*ï¼‰|\([^)]*\)/g);
            const vHint = document.getElementById('visual-hint');
            vHint.style.display = (cMatch || cur.visual) ? 'block' : 'none';
            document.getElementById('visual-text').innerText = (cMatch ? cMatch.join("") : "") || cur.visual || "";
            
            document.getElementById('progress-inner').style.width = ((step/scenario.length)*100) + "%";
            speak(qEng, () => { 
                document.getElementById('status').innerText = "TAP TO SPEAK"; 
                document.getElementById('mic-text').innerText = "TALK"; 
            });
        }

        rec.onend = () => { 
            isRecording = false; 
            document.getElementById('mic-btn').classList.remove('recording'); 
            document.getElementById('mic-icon').innerText = "ðŸŽ¤"; 
            document.getElementById('timer-container').style.display = 'none'; 
            if (step !== -1 && step < scenario.length) document.getElementById('mic-text').innerText = "TALK";
        };

        function startRecording() { 
            try { 
                rec.start(); isRecording = true; 
                document.getElementById('mic-btn').classList.add('recording'); 
                document.getElementById('mic-icon').innerText = "ðŸ›‘";
                const tb = document.getElementById('timer-bar'); 
                document.getElementById('timer-container').style.display = 'block';
                tb.style.transition = 'none'; tb.style.width = '100%';
                setTimeout(() => { 
                    tb.style.transition = `width ${COUNTDOWN_TIME}ms linear`; 
                    tb.style.width = '0%'; 
                }, 10);
                countdownTimer = setTimeout(() => { if(isRecording) { stopRecording(); handleFailure(); } }, COUNTDOWN_TIME);
            } catch(e){} 
        }
        function stopRecording() { clearTimeout(countdownTimer); try { rec.stop(); } catch(e){} }
        function updateUI(n, s, e) { document.getElementById('npc-text').innerText = n; document.getElementById('npc-text').style.color = "#1b5e20"; document.getElementById('status').innerText = s; if(e) document.getElementById('big-emoji').innerText = e; }
        function resetTimerUI() { document.getElementById('timer-container').style.display = 'none'; document.getElementById('timer-bar').style.width = '100%'; }
        function goBack() { 
            stopRecording(); 
            window.speechSynthesis.cancel(); 
            if (step > 0) { step--; startStep(); } 
            else if (step === -1 || step >= scenario.length) { step = scenario.length - 1; startStep(); }
        }
        function goNext() { stopRecording(); window.speechSynthesis.cancel(); if (step < scenario.length) { step++; startStep(); } }
        function resetGame() { location.reload(); }
    </script>
</body>
</html>
